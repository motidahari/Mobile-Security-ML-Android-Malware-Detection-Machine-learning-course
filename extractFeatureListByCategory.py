import json
from setting import config
import re


def exportToTextFile(lst, text_file_path) -> bool:
    # open the text file in write mode
    with open(text_file_path, 'w') as f:
        # iterate through the feature list and write each feature to a new line in the text file
        for val in lst:
            f.write(val + '\n')
    print(f'Successfully exported lst to {text_file_path}')
    return True


def extractFeatureCategoryValuesFromTextFile():
    featureListPath = '{path}/featureList.txt'.format(
        path=config['resultApksPath'])
    # create an empty dictionary to store the data
    data = {}
    # open the text file
    with open(featureListPath, 'r') as f:
        # iterate through each line in the file
        for line in f:

            match = re.search(r"(.*)::(.*)", line)
            if match:
                key = match.group(1)
                value = match.group(2)
                # if the key is not already in the dictionary, add it
                if key not in data:
                    data[key] = []
                # append the value to the list of values for the key
                data[key].append(value)

    print('data.keys', data.keys())
    for key in data.keys():

        resultPath = '{path}/{fileName}.txt'.format(
            path=config['resultApksPath'], fileName=key)
        exportToTextFile(data[key], resultPath)
    return data


def extractFeatureListFromJson():
    json_file_path = config['apksResultJsonPath']
    resultPath = '{path}/featureList.txt'.format(
        path=config['resultApksPath'])
    # open the json file and load it into a variable
    with open(json_file_path, 'r') as f:
        data = json.load(f)

    # create an empty set to store the unique properties
    unique_props = set()

    # iterate through each object in the json
    for obj in data:
        # add each property to the set, this will automatically remove duplicates
        unique_props.update(obj.keys())
    extractFeatureCategoryValuesFromTextFile()
    # return the set of unique properties
    if exportToTextFile(unique_props, resultPath):
        return unique_props
    raise ValueError("Error while try to expert file")


extractFeatureListFromJson()
